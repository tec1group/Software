0000                             ; TEC Maze Treasure Hunt.
0000                             ; 
0000                             ; By
0000                             ; Brian Chiha -- June 2020
0000                             ; brian.chiha@gmail.com
0000                             ; 
0000                             ; Glowing Orb Treasure Hunt
0000                             ; -------------------------
0000                             ; 
0000                             ; Setup
0000                             ; -----
0000                             ; 
0000                             ; To be run on the TEC-1D with either JMON or MON2.  For the keyboard to work
0000                             ; it requires EITHER a 4k7 (or 2k2) resistor between the NMI (pin 17 on Z-80)
0000                             ; and D6 (pin 10 on the Z-80) OR the DAT (LCD) expanstion board fitted to port 3.
0000                             ; The current TEC-1D boards have the JMON MOD resitor connection already there.
0000                             ; The 8x8 LED board is fitted to ports 5 and 6 with the port select strobe of the
0000                             ; left hand latch going to port 6.
0000                             ; 
0000                             ; To Play
0000                             ; -------
0000                             ; 
0000                             ; The aim is to move around the maze, and pick up all glowing orbs. Once all are found,
0000                             ; get back to your starting spot.  To move use the following keys
0000                             ; 
0000                             ;         6
0000                             ;     1 < O > 9
0000                             ;         4
0000                             ; 
0000                             ; Your character is a 1x1 Steady LED.  Orbs are flashing (glistening!) 1x1 LED's.
0000                             ; The Seven Segments display your current location (Address) and the number of treasures
0000                             ; to collect (Data).  You must find all orbs to win.  Just move over the orb to
0000                             ; pick it up but only when you can see it!
0000                             ; 
0000                             ; The Maze has a total of 64 rooms on an 8x8 grid.  Rooms are represented vertically
0000                             ; with A-H and horizontally with 0-7.  Top left is "A0".  Orbs and initially
0000                             ; player positions are randomly placed at the start of the game.  The number of orbs
0000                             ; to find is random for each game.
0000                             ;Data locations
0000                SCREEN:   EQU   5000H   ;Game Screen                                           (8-bytes)
0000                ROTSCR:   EQU   5008H   ;Pre Screen area for rotation                          (8-bytes)
0000                TRESUR:   EQU   5010H   ;Treasure Location 1 byte per row                      (8-bytes)
0000                PLAYRM:   EQU   5018H   ;Player current room lnib=vertical, unib=horizontal    (1-byte)
0000                PLAYSC:   EQU   5019H   ;Player current Treasure Count                         (1-byte)
0000                PLAYER:   EQU   501AH   ;Position of player X (Byte 1) and Y (Byte 2)          (2-bytes)
0000                CURRRM:   EQU   501CH   ;Current room number 00-3F (64 rooms)                  (1-byte)
0000                STARTR:   EQU   501DH   ;Start room to signify end of game                     (1-byte)
0000                RANDNO:   EQU   501EH   ;Random number for more randomness                     (1-byte)
0000                KEYPRE:   EQU   501FH   ;Key Pressed Flag, 00-False, FF-True                   (1-byte)
0000                LEDSCR:   EQU   5020H   ;LED Display for Map Reference and treasure count      (6-bytes)
0000                TRELOC:   EQU   5026H   ;Position of treasure X (Byte 1) and Y (Byte 2)        (2-bytes)
4000                          .ORG   4000H   
4000                START:       
4000                             ;Welcome Screen
4000   CD E5 42               CALL   CLRSCR   
4003   CD A0 42               CALL   INTROM   
4006                             ;New game setup
4006   CD 8D 41               CALL   SETUP   
4009                GAME:        
4009   CD 2A 40               CALL   PLAYMV   ;Player movement
400C                             ; Display Updates
400C   CD D0 41               CALL   UPDSCR   ;Update Screen
400F   CD FF 41               CALL   UPDSCO   ;Update 7-Segments
4012   CD 33 42               CALL   SCAN   ;Scan the 8x8 and Seven Segments
4015                             ;Check if treausre count = 0 and player is in starting position
4015                             ;then display game over and restart
4015   3A 19 50               LD   A,(PLAYSC)   
4018   B7                     OR   A   
4019   20 EE                  JR   NZ,GAME   ;Still treasure remaining
401B   3A 1D 50               LD   A,(STARTR)   
401E   47                     LD   B,A   
401F   3A 1C 50               LD   A,(CURRRM)   
4022   90                     SUB   B   
4023   20 E4                  JR   NZ,GAME   ;Not in starting room
4025   CD C1 42               CALL   GAMEOV   ;Call game over routine
4028   18 D6                  JR   START   
402A                             ;Player Movement.  This includes map movements, and collisions on walls.  Player
402A                             ;can move up (6), down (4), left (1) and right (9). When player moves off the screen
402A                             ;A new map is drawn.  This method is a bit messy and could be optimised
402A                PLAYMV:      
402A                             ; Test for key pressed with D6 set
402A   DB 03                  IN   A,(03)   
402C   CB 77                  BIT   6,A   ; Bit 6, If not set A=NZ
402E   28 05                  JR   Z,MP1   
4030                             ; Store 0 for last key if no key pressed
4030   AF                     XOR   A   
4031   32 1F 50               LD   (KEYPRE),A   
4034   C9                     RET      
4035                MP1:         
4035                             ; Key has been pressed
4035   3A 1F 50               LD   A,(KEYPRE)   
4038   B7                     OR   A   
4039   C0                     RET   NZ   ; Just return if same
403A   3E FF                  LD   A,0FFH   
403C   32 1F 50               LD   (KEYPRE),A   
403F                             ; Get Key
403F   DB 00                  IN   A,(00)   
4041   E6 1F                  AND   01FH   ; Mask unwanted bits
4043   ED 5B 1A 50            LD   DE,(PLAYER)   ;Player position for checking
4047   21 1C 50               LD   HL,CURRRM   
404A                             ; Check for Valid Keys
404A                LEFT:        
404A   FE 04                  CP   04H   ; Left
404C   20 07                  JR   NZ,RIGHT   
404E   7B                     LD   A,E   ;X pos
404F   07                     RLCA      
4050   38 23                  JR   C,MOVELT   ;Carry means move to new room and save new player position
4052   5F                     LD   E,A   
4053   18 3C                  JR   CHKCOL   ;Check for collision
4055                RIGHT:       
4055   FE 06                  CP   06H   ; Right
4057   20 07                  JR   NZ,UP   
4059   7B                     LD   A,E   ;X pos
405A   0F                     RRCA      
405B   38 1C                  JR   C,MOVERT   ;Carry means move to new room and save new player position
405D   5F                     LD   E,A   
405E   18 31                  JR   CHKCOL   ;Check for collision
4060                UP:          
4060   FE 09                  CP   09H   ; Up
4062   20 07                  JR   NZ,DOWN   
4064   7A                     LD   A,D   ;Y pos
4065   07                     RLCA      
4066   38 15                  JR   C,MOVEUP   ;Carry means move to new room and save new player position
4068   57                     LD   D,A   
4069   18 26                  JR   CHKCOL   ;Check for collision
406B                DOWN:        
406B   FE 01                  CP   01H   ; Down
406D   C0                     RET   NZ   
406E   7A                     LD   A,D   ;Y pos
406F   0F                     RRCA      
4070   38 12                  JR   C,MOVEDN   ;Carry means move to new room and save new player position
4072   57                     LD   D,A   
4073   18 1C                  JR   CHKCOL   ;Check for collision
4075                MOVELT:      
4075   5F                     LD   E,A   
4076   35                     DEC   (HL)   
4077   18 10                  JR   UPDROO   
4079                MOVERT:      
4079   5F                     LD   E,A   
407A   34                     INC   (HL)   
407B   18 0C                  JR   UPDROO   
407D                MOVEUP:      
407D   57                     LD   D,A   
407E   7E                     LD   A,(HL)   
407F   D6 08                  SUB   08H   
4081   77                     LD   (HL),A   
4082   18 05                  JR   UPDROO   
4084                MOVEDN:      
4084   57                     LD   D,A   
4085   7E                     LD   A,(HL)   
4086   C6 08                  ADD   A,08H   
4088   77                     LD   (HL),A   
4089                UPDROO:      
4089                             ;Update to a new room and save new player location
4089   ED 53 1A 50            LD   (PLAYER),DE   ;Move player
408D   CD EA 40               CALL   NWROOM   
4090   C9                     RET      ;Exit from PLAYMV
4091                             ;Check that player doesn"t collide with wall.  IF so just exit and don"t update player
4091                             ;position.  Else, Jump to UPDROO to wipe old player position and save new player position
4091                             ;DE = player position to test.  D = X, E = Y
4091                CHKCOL:      
4091   21 00 50               LD   HL,SCREEN   
4094                             ;Find X  Pos on screen
4094   7B                     LD   A,E   
4095                MP2:         
4095   07                     RLCA      ;1 Bit is always present
4096   38 03                  JR   C,MP3   
4098   23                     INC   HL   
4099   18 FA                  JR   MP2   
409B                MP3:         
409B   7E                     LD   A,(HL)   ;Get X column
409C   A2                     AND   D   ;See if Y is set
409D   28 3B                  JR   Z,MP8   ;Collision!! If NZ
409F                             ;If collision check if treasure, (ie player = treloc)
409F                             ;then if so, remove treasure otherwise RET and don't update room
409F   2A 26 50               LD   HL,(TRELOC)   
40A2   B7                     OR   A   
40A3   ED 52                  SBC   HL,DE   ;Compare HL and DE, if the same then Zero flag is set
40A5   19                     ADD   HL,DE   
40A6   C0                     RET   NZ   ;Different so must be wall.
40A7                             ; Remove Treasure BIT then fall through and update player location
40A7   21 10 50               LD   HL,TRESUR   ; Treasure Rows
40AA   3A 18 50               LD   A,(PLAYRM)   ; Current player room to find correct TRESUR
40AD   F5                     PUSH   AF   
40AE   E6 0F                  AND   0FH   ; Get X pos
40B0                MP4:         
40B0   B7                     OR   A   ;Check for 0
40B1   28 04                  JR   Z,MP5   
40B3   3D                     DEC   A   
40B4   23                     INC   HL   ;Move to correct row
40B5   18 F9                  JR   MP4   
40B7                MP5:         
40B7   F1                     POP   AF   
40B8   07                     RLCA      
40B9   07                     RLCA      
40BA   07                     RLCA      
40BB   07                     RLCA      
40BC   E6 0F                  AND   0FH   ;Get Y position
40BE   06 01                  LD   B,01H   ;Set up bit to XOR with (HL)
40C0                MP6:         
40C0   B7                     OR   A   ;Check for 0
40C1   28 05                  JR   Z,MP7   
40C3   CB 00                  RLC   B   
40C5   3D                     DEC   A   
40C6   18 F8                  JR   MP6   
40C8                MP7:         
40C8   7E                     LD   A,(HL)   
40C9   A8                     XOR   B   ;Remove Y Bit from A
40CA   77                     LD   (HL),A   ;Update HL with bit removed and fall through to update player pos
40CB   21 00 00               LD   HL,0000H   
40CE   22 26 50               LD   (TRELOC),HL   ;Remove Treasure in room
40D1   3A 19 50               LD   A,(PLAYSC)   
40D4   D6 01                  SUB   01H   ;Decrease treasure count
40D6   27                     DAA      
40D7   32 19 50               LD   (PLAYSC),A   
40DA                MP8:         
40DA                             ;No collision to move player to new position and update screen to
40DA                             ;remove pevious player position
40DA   ED 53 1A 50            LD   (PLAYER),DE   ;Move player
40DE                             ;Copy Rotated Original room to Screen
40DE   01 08 00               LD   BC,0008H   ;Copy rotation area to screen
40E1   21 08 50               LD   HL,ROTSCR   
40E4   11 00 50               LD   DE,SCREEN   
40E7   ED B0                  LDIR      
40E9   C9                     RET      ;Exit from PLAYMV
40EA                             ;Go to a new room.  This finds the next room and rotates it to the correct direction
40EA                NWROOM:      
40EA   CD 14 42               CALL   UPDRCO   ;Update room coordinates
40ED   CD 49 41               CALL   CRETRE   ;Create Treasure if room has active treasure
40F0   21 46 43               LD   HL,MAZERM   
40F3   3A 1C 50               LD   A,(CURRRM)   
40F6   85                     ADD   A,L   
40F7   6F                     LD   L,A   ;Index the currect room
40F8   7E                     LD   A,(HL)   ;Get Map
40F9                             ;LSB is the room reference
40F9                             ;MSB is the rotation
40F9   F5                     PUSH   AF   
40FA   E6 0F                  AND   0FH   ;Get Room to use LSB
40FC   21 3C 43               LD   HL,ROOMLU   
40FF   87                     ADD   A,A   ;Double it for two byte indexing
4100   85                     ADD   A,L   
4101   6F                     LD   L,A   ;Index the room
4102   7E                     LD   A,(HL)   
4103   23                     INC   HL   
4104   66                     LD   H,(HL)   
4105   6F                     LD   L,A   
4106   01 08 00               LD   BC,0008H   ;Copy map data to rotation area
4109   11 08 50               LD   DE,ROTSCR   
410C   ED B0                  LDIR      
410E   F1                     POP   AF   ;Get rotation
410F   07                     RLCA      
4110   07                     RLCA      
4111   07                     RLCA      
4112   07                     RLCA      
4113   E6 0F                  AND   0FH   
4115   47                     LD   B,A   ;Save rotation for rotation count if needed
4116   B7                     OR   A   ;If no rotaion needed just copy to screen
4117   20 0C                  JR   NZ,ROTCW   
4119   01 08 00               LD   BC,0008H   ;Copy rotation area to screen
411C   21 08 50               LD   HL,ROTSCR   
411F   11 00 50               LD   DE,SCREEN   
4122   ED B0                  LDIR      
4124   C9                     RET      ;Exit
4125                             ;Rotate map B times anti-clockwise and update screen at the same time
4125                ROTCW:       
4125   C5                     PUSH   BC   
4126   11 00 50               LD   DE,SCREEN   
4129   06 08                  LD   B,08H   
412B                ROT1:        
412B   C5                     PUSH   BC   
412C   06 08                  LD   B,08H   
412E   21 08 50               LD   HL,ROTSCR   
4131   AF                     XOR   A   
4132                ROT2:        
4132   CB 06                  RLC   (HL)   
4134   1F                     RRA      
4135   23                     INC   HL   
4136   10 FA                  DJNZ   ROT2   
4138   12                     LD   (DE),A   
4139   13                     INC   DE   
413A   C1                     POP   BC   
413B   10 EE                  DJNZ   ROT1   
413D   01 08 00               LD   BC,0008H   ;Copy new screen data to rotation area
4140   21 00 50               LD   HL,SCREEN   
4143   ED B0                  LDIR      
4145   C1                     POP   BC   
4146   10 DD                  DJNZ   ROTCW   ; Repeat for all rotations
4148   C9                     RET      
4149                             ;Create Treasure.  Using the bits set in TRESUR, see if room has treasure.  If so
4149                             ;Place it somewhere within the four squares of center of the room.  If no treasure in room
4149                             ;Clear out treasure location
4149                CRETRE:      
4149                             ; Using PLAYRM (previously set), work out which row and column to check in TRESUR
4149                             ; To set if the bit is set for the room.
4149   21 10 50               LD   HL,TRESUR   ;Find the correct row (X coordinate)
414C   11 26 50               LD   DE,TRELOC   ;Treasure location X and Y if any
414F   3A 18 50               LD   A,(PLAYRM)   
4152   F5                     PUSH   AF   
4153   07                     RLCA      
4154   07                     RLCA      
4155   07                     RLCA      
4156   07                     RLCA      
4157   E6 0F                  AND   0FH   ;Get Y position
4159   47                     LD   B,A   ;Save Y in B
415A   F1                     POP   AF   
415B   E6 0F                  AND   0FH   ;Get X position
415D                CR1:         
415D   B7                     OR   A   ;Check for 0
415E   28 04                  JR   Z,CR2   
4160   3D                     DEC   A   
4161   23                     INC   HL   
4162   18 F9                  JR   CR1   
4164                CR2:         
4164   7E                     LD   A,(HL)   ;Now find if bit is set
4165   4F                     LD   C,A   
4166   78                     LD   A,B   ;Y position
4167                CR3:         
4167   B7                     OR   A   ;Check for 0
4168   28 05                  JR   Z,CR4   
416A   CB 09                  RRC   C   
416C   3D                     DEC   A   
416D   18 F8                  JR   CR3   
416F                CR4:         
416F   CB 41                  BIT   0,C   ;Check if bit is set, if so, treausre is found
4171   28 16                  JR   Z,CR7   ;Not set
4173                             ; To set a random location, I use row random number, and mask out lower and upper
4173                             ; nibble with 3.  Then add 2 to it to get a number between 2-5 which are the
4173                             ; center bits.
4173   7E                     LD   A,(HL)   ;Row Bits
4174   CD 7C 41               CALL   CR5   
4177   7E                     LD   A,(HL)   ;Row Bits
4178   07                     RLCA      
4179   07                     RLCA      
417A   07                     RLCA      
417B   07                     RLCA      ;Fall through to call
417C                CR5:         
417C   E6 03                  AND   03H   ;Mask bottom 3 bits only
417E   C6 02                  ADD   A,02H   ;Put in range of 2-5
4180   47                     LD   B,A   
4181   3E 01                  LD   A,01H   ;Set one bit
4183                CR6:         
4183   07                     RLCA      
4184   10 FD                  DJNZ   CR6   
4186   12                     LD   (DE),A   
4187   13                     INC   DE   
4188   C9                     RET      
4189                CR7:         
4189   12                     LD   (DE),A   ;   A is 0 if here
418A   13                     INC   DE   
418B   12                     LD   (DE),A   ; 
418C   C9                     RET      
418D                             ;Randomly place treasure and initial room for player
418D                SETUP:       
418D                             ; Initial Player Position
418D   3E 08                  LD   A,08H   ;Around the middle of the screen
418F   32 1A 50               LD   (PLAYER),A   
4192   32 1B 50               LD   (PLAYER+1),A   
4195                             ; Starting Room
4195   CD 61 42               CALL   RANDOM   ;Find Random Starting Room
4198   E6 3F                  AND   3FH   ;0-63 rooms
419A   32 1C 50               LD   (CURRRM),A   
419D   32 1D 50               LD   (STARTR),A   ;Save start room
41A0                             ; Treasure Placement is done by placing a random number in eight rows
41A0                             ; Each set bit on the row represents the column that the treasure is in.
41A0                             ; Once the player enters a room with treasure it is placed somewhere in the
41A0                             ; room.  If it get picked up, the bit is removed.
41A0   0E 08                  LD   C,08H   ;8 rows
41A2   21 10 50               LD   HL,TRESUR   
41A5                SUP1:        
41A5   CD 61 42               CALL   RANDOM   
41A8   77                     LD   (HL),A   ;Save random number to row
41A9   23                     INC   HL   
41AA   0D                     DEC   C   
41AB   20 F8                  JR   NZ,SUP1   
41AD                             ; Add up treasures (bits in each row) and save into PLAYSC.  This code is a
41AD                             ; bit ineffcient but it only gets called once at startup.
41AD   11 08 00               LD   DE,0008H   ;E=8 rows and D=0 total treasure
41B0   21 10 50               LD   HL,TRESUR   
41B3                SUP2:        
41B3   7E                     LD   A,(HL)   
41B4   06 08                  LD   B,08H   ;8 bits per byte
41B6                SUP3:        
41B6   07                     RLCA      
41B7   30 01                  JR   NC,SUP4   
41B9   14                     INC   D   
41BA                SUP4:        
41BA   10 FA                  DJNZ   SUP3   
41BC   23                     INC   HL   
41BD   1D                     DEC   E   
41BE   20 F3                  JR   NZ,SUP2   
41C0   7A                     LD   A,D   
41C1   CD 93 42               CALL   HEX2BCD   
41C4   32 19 50               LD   (PLAYSC),A   
41C7                             ; Zero Default
41C7   3E 00                  LD   A,00H   
41C9   32 1F 50               LD   (KEYPRE),A   
41CC   CD EA 40               CALL   NWROOM   ;Draw first room and update room coordinates
41CF   C9                     RET      
41D0                             ;Redraw screen with player movement
41D0                UPDSCR:      
41D0                             ;Place Player. Move HL to X pos, then OR with Y pos
41D0   3A 1A 50               LD   A,(PLAYER)   ; Get X pos
41D3   21 00 50               LD   HL,SCREEN   
41D6                U1:          
41D6   07                     RLCA      ;1 Bit is always present
41D7   38 03                  JR   C,U2   ;Move HL to X position
41D9   23                     INC   HL   
41DA   18 FA                  JR   U1   
41DC                U2:          
41DC   3A 1B 50               LD   A,(PLAYER+1)   
41DF   47                     LD   B,A   
41E0   7E                     LD   A,(HL)   
41E1   B0                     OR   B   
41E2   77                     LD   (HL),A   ;Update HL with Y position
41E3                             ;Place Treasure if any. Move HL to X pos, then OR with Y pos
41E3                             ;Treausre is only shown if RANDOM number > 80H (128 decimal)
41E3                             ;This creates a glistening effect
41E3   CD 61 42               CALL   RANDOM   
41E6   D6 20                  SUB   20H   
41E8   D0                     RET   NC   ;Dont print treasure if result is negative
41E9   3A 26 50               LD   A,(TRELOC)   ; Get X pos
41EC   B7                     OR   A   ; If 0 no treasure
41ED   C8                     RET   Z   
41EE   21 00 50               LD   HL,SCREEN   
41F1                U3:          
41F1   07                     RLCA      ;1 Bit is always present
41F2   38 03                  JR   C,U4   ;Move HL to X position
41F4   23                     INC   HL   
41F5   18 FA                  JR   U3   
41F7                U4:          
41F7   3A 27 50               LD   A,(TRELOC+1)   
41FA   47                     LD   B,A   
41FB   7E                     LD   A,(HL)   
41FC   B0                     OR   B   
41FD   77                     LD   (HL),A   ;Update HL with Y position
41FE   C9                     RET      
41FF                             ;Update segement data
41FF                             ;Update the LED's to display the LEDSCR buffer based off PLAYRM & PLAYSC
41FF                UPDSCO:      
41FF   01 20 50               LD   BC,LEDSCR   ;Location of screen buffer
4202   21 18 50               LD   HL,PLAYRM   ;Player Position (1) and Treasures (1)
4205   AF                     XOR   A   ;Blank first two entries
4206   02                     LD   (BC),A   
4207   03                     INC   BC   
4208   02                     LD   (BC),A   
4209   03                     INC   BC   
420A   7E                     LD   A,(HL)   
420B   CD 6E 42               CALL   SEGCON   ;Convert A to Segment Hex, Store in BC
420E   23                     INC   HL   
420F   7E                     LD   A,(HL)   
4210   CD 6E 42               CALL   SEGCON   ;Convert A to Segment Hex, Store in BC
4213   C9                     RET      
4214                             ;Update room coordinates.  Based on the current room
4214                             ;Divide Current room by 8, result = A (Vert), remainder = B (Horiz)
4214                UPDRCO:      
4214   3A 1C 50               LD   A,(CURRRM)   
4217   5F                     LD   E,A   ;Current Room
4218   0E 08                  LD   C,08H   ;Divisor
421A   06 08                  LD   B,08H   ;8 bit divide routine
421C   AF                     XOR   A   
421D                SU1:         
421D   CB 13                  RL   E   
421F   17                     RLA      
4220   91                     SUB   C   
4221   30 01                  JR   NC,SU2   
4223   81                     ADD   A,C   
4224                SU2:         
4224   10 F7                  DJNZ   SU1   
4226   47                     LD   B,A   
4227   7B                     LD   A,E   
4228   17                     RLA      
4229   2F                     CPL      
422A   07                     RLCA      ;Store AB into PLAYRM
422B   07                     RLCA      
422C   07                     RLCA      
422D   07                     RLCA      
422E   80                     ADD   A,B   
422F   32 18 50               LD   (PLAYRM),A   
4232   C9                     RET      
4233                             ;Utility Routines..
4233                             ; Multiplex the 8x8 Display and the Seven Segment LEDS
4233                SCAN:        
4233   06 10                  LD   B,10H   
4235                S1:          
4235   C5                     PUSH   BC   
4236   06 01                  LD   B,01H   ;Counter for 8x8
4238   21 00 50               LD   HL,SCREEN   
423B   11 25 50               LD   DE,LEDSCR+5   
423E                S2:          
423E   7E                     LD   A,(HL)   
423F   D3 06                  OUT   (06),A   
4241   1A                     LD   A,(DE)   
4242   D3 02                  OUT   (02),A   
4244   78                     LD   A,B   
4245   D3 05                  OUT   (05),A   
4247   FE 80                  CP   80H   ;If port 80 (Speaker), Skip
4249   28 02                  JR   Z,S3   
424B   D3 01                  OUT   (01),A   
424D                S3:          
424D   06 40                  LD   B,40H   
424F   10 FE        S4:       DJNZ   S4   
4251   47                     LD   B,A   
4252   AF                     XOR   A   
4253   D3 05                  OUT   (05),A   
4255   D3 01                  OUT   (01),A   
4257   1B                     DEC   DE   
4258   23                     INC   HL   
4259   CB 00                  RLC   B   
425B   30 E1                  JR   NC,S2   
425D   C1                     POP   BC   
425E   10 D5                  DJNZ   S1   
4260   C9                     RET      
4261                             ;Random number generator.  A - Returns a number between 00 and FF
4261                RANDOM:      
4261   ED 5F                  LD   A,R   
4263   47                     LD   B,A   
4264   3A 1E 50               LD   A,(RANDNO)   
4267   A8                     XOR   B   
4268   87                     ADD   A,A   
4269   A8                     XOR   B   
426A   32 1E 50               LD   (RANDNO),A   
426D   C9                     RET      
426E                             ;Convert A to two display bytes for Seven Segment, Store Result in location of BC
426E                SEGCON:      
426E   F5                     PUSH   AF   
426F   07                     RLCA      
4270   07                     RLCA      
4271   07                     RLCA      
4272   07                     RLCA      
4273                             ; Need to check if displaying a letter or number.  This only applys for the
4273                             ; player room coordinates.  If HL = PLAYRM then and on upper nibble then add
4273                             ; 0A to the table index
4273   11 18 50               LD   DE,PLAYRM   
4276   B7                     OR   A   ;Reset carry flag
4277   ED 52                  SBC   HL,DE   ;Compare HL and DE, if the same then Zero flag is set
4279   19                     ADD   HL,DE   
427A   20 05                  JR   NZ,SC1   
427C   11 90 43               LD   DE,SEGTBL+0AH   
427F   18 03                  JR   SC2   
4281                SC1:         
4281   11 86 43               LD   DE,SEGTBL   
4284                SC2:         
4284   CD 8B 42               CALL   SC3   
4287   F1                     POP   AF   
4288   11 86 43               LD   DE,SEGTBL   
428B                SC3:         
428B   E6 0F                  AND   0FH   
428D   83                     ADD   A,E   
428E   5F                     LD   E,A   
428F   1A                     LD   A,(DE)   
4290   02                     LD   (BC),A   
4291   03                     INC   BC   
4292   C9                     RET      
4293                             ;Hex to BCD converter.  Converts A in Hex to BCD equivilant.
4293                HEX2BCD:      
4293   C5                     PUSH   BC   
4294   4F                     LD   C,A   
4295   06 08                  LD   B,08H   
4297   AF                     XOR   A   
4298                H1:          
4298   CB 21                  SLA   C   
429A   8F                     ADC   A,A   
429B   27                     DAA      
429C   10 FA                  DJNZ   H1   
429E   C1                     POP   BC   
429F   C9                     RET      
42A0                             ;8x8 Scroll routine to scroll data from right to left.  Data is referenced in HL
42A0                             ;First Byte is number of columns to scroll followed by vertical byte display upwards
42A0                             ;This routine includes the 8x8 multiplex
42A0                INTROM:      
42A0   21 98 43               LD   HL,INTMSG   
42A3   7E                     LD   A,(HL)   ;Column count
42A4   4F                     LD   C,A   
42A5                SL1:         
42A5   06 07                  LD   B,07H   
42A7   DD 21 00 50            LD   IX,SCREEN   
42AB                SL2:         
42AB   DD 7E 01               LD   A,(IX+1)   ;Shift seven columns
42AE   DD 77 00               LD   (IX+0),A   
42B1   DD 23                  INC   IX   
42B3   10 F6                  DJNZ   SL2   
42B5   23                     INC   HL   
42B6   7E                     LD   A,(HL)   
42B7   32 07 50               LD   (SCREEN+7),A   
42BA   CD F3 42               CALL   SCAN88   
42BD   0D                     DEC   C   
42BE   20 E5                  JR   NZ,SL1   
42C0   C9                     RET      
42C1                             ;8x8 Flasher routine.  This displays data for the 8x8 similar to the scroll but shows
42C1                             ;one page (8x8) at a time instead of sequentially scrolling.  Data is referenced in HL
42C1                             ;First byte is the number of pages to show followed by vertical byte display upwards
42C1                             ;Useful for animations using the 8x8.  This is used as a game over screen.  It loops
42C1                             ;until any key is pressed
42C1                GAMEOV:      
42C1   21 D2 43               LD   HL,OVRMSG   
42C4   7E                     LD   A,(HL)   ;Page count
42C5   23                     INC   HL   
42C6   4F                     LD   C,A   
42C7                F1:          
42C7   C5                     PUSH   BC   
42C8   11 00 50               LD   DE,SCREEN   
42CB   01 08 00               LD   BC,0008H   
42CE   ED B0                  LDIR      ;Copy Through to screen area
42D0   06 0B                  LD   B,0BH   
42D2                F2:          
42D2   C5                     PUSH   BC   
42D3   CD F3 42               CALL   SCAN88   
42D6   C1                     POP   BC   
42D7   10 F9                  DJNZ   F2   
42D9   C1                     POP   BC   
42DA   DB 03                  IN   A,(03)   
42DC   CB 77                  BIT   6,A   ; Bit 6, If not set A=NZ
42DE   C8                     RET   Z   
42DF   0D                     DEC   C   
42E0   20 E5                  JR   NZ,F1   ;Do next screen
42E2   18 DD                  JR   GAMEOV   
42E4   C9                     RET      
42E5                CLRSCR:      
42E5   21 00 50               LD   HL,SCREEN   
42E8   11 01 50               LD   DE,SCREEN+1   
42EB   AF                     XOR   A   
42EC   77                     LD   (HL),A   
42ED   01 07 00               LD   BC,07H   
42F0   ED B0                  LDIR      
42F2   C9                     RET      
42F3                             ; Multiplex the 8x8 Display
42F3                SCAN88:      
42F3   E5                     PUSH   HL   
42F4   06 15                  LD   B,15H   
42F6                S81:         
42F6   C5                     PUSH   BC   
42F7   06 01                  LD   B,01H   ;Counter for 8x8
42F9   21 00 50               LD   HL,SCREEN   
42FC                S82:         
42FC   7E                     LD   A,(HL)   
42FD   D3 06                  OUT   (06),A   
42FF   78                     LD   A,B   
4300   D3 05                  OUT   (05),A   
4302   06 80                  LD   B,80H   
4304   10 FE        S83:      DJNZ   S83   
4306   23                     INC   HL   
4307   47                     LD   B,A   
4308   AF                     XOR   A   
4309   D3 05                  OUT   (05),A   
430B   CB 00                  RLC   B   
430D   30 ED                  JR   NC,S82   
430F   C1                     POP   BC   
4310   10 E4                  DJNZ   S81   
4312   E1                     POP   HL   
4313   C9                     RET      
4314                             ; Game Data
4314                             ; Five room squares are used.  A Cross, T junction, straight, Bend and Cul-de-sac.
4314                             ; In order to use these indifferent rotations the room reference byte is split into
4314                             ; two. The LSB is the room to use and the MSB is the rotation of it.
4314                             ; The LSB for the rooms are
4314                             ; 
4314                             ; Cross = 0
4314                             ; T junction = 1
4314                             ; Straight = 2
4314                             ; Bend = 3
4314                             ; Cul-de-sac = 4
4314                             ; 
4314                             ; Maps are rotated 90 anti-clockwise with 0=no rotation, 1=90, 2=180 and 3=270
4314                             ; EG: a Bend at 180 degress is 23H
4314                             ; 
4314   C3 C3 00 00 00 00 C3 C3 CROSSR:   DB   0C3H,0C3H,00H,00H,00H,00H,0C3H,0C3H   ;Cross (+)
431C   C3 C3 C0 C0 C0 C0 C3 C3 TJUNCR:   DB   0C3H,0C3H,0C0H,0C0H,0C0H,0C0H,0C3H,0C3H   ;T Junction (T)
4324   C3 C3 C3 C3 C3 C3 C3 C3 STRGTR:   DB   0C3H,0C3H,0C3H,0C3H,0C3H,0C3H,0C3H,0C3H   ;Straight (=)
432C   FF FF 03 03 03 03 C3 C3 BENDRM:   DB   0FFH,0FFH,03H,03H,03H,03H,0C3H,0C3H   ;Bend (L)
4334   FF FF C3 C3 C3 C3 C3 C3 CULDSR:   DB   0FFH,0FFH,0C3H,0C3H,0C3H,0C3H,0C3H,0C3H   ;Cul-De-Sac (C)
433C                             ; Room Lookup
433C   14 43 1C 43 24 43 2C 43 34 43 ROOMLU:   DW   CROSSR,TJUNCR,STRGTR,BENDRM,CULDSR   
4346                             ; Map
4346   04 01 02 02 23 33 02 24 MAZERM:   DB   04H,01H,02H,02H,23H,33H,02H,24H   
434E   33 13 33 02 13 03 02 23 DB   33H,13H,33H,02H,13H,03H,02H,23H   
4356   11 23 03 24 33 02 23 12 DB   11H,23H,03H,24H,33H,02H,23H,12H   
435E   14 03 02 02 00 23 11 13 DB   14H,03H,02H,02H,00H,23H,11H,13H   
4366   33 24 33 23 11 31 03 23 DB   33H,24H,33H,23H,11H,31H,03H,23H   
436E   03 02 31 12 12 03 23 12 DB   03H,02H,31H,12H,12H,03H,23H,12H   
4376   33 24 12 03 13 04 13 12 DB   33H,24H,12H,03H,13H,04H,13H,12H   
437E   03 02 21 24 04 02 02 13 DB   03H,02H,21H,24H,04H,02H,02H,13H   
4386                             ;SPOILER - This is the actual maze
4386                             ;            0 1 2 3 4 5 6 7
4386                             ;           +-+-+-+-+-+-+-+-+
4386                             ;       A   |         |     |
4386                             ;           +-+ +-+-+ + +-+-+
4386                             ;       B   |   |     |     |
4386                             ;           + +-+ +-+-+-+-+ +
4386                             ;       C   |   |   |     | |
4386                             ;           + + +-+-+ +-+ + +
4386                             ;       D   | |         |   |
4386                             ;           +-+-+-+-+ + + +-+
4386                             ;       E   |   |   |   |   |
4386                             ;           + +-+ + + + +-+ +
4386                             ;       F   |     | | |   | |
4386                             ;           +-+-+ + + +-+ + +
4386                             ;       G   |   | |   |   | |
4386                             ;           + +-+ +-+-+-+-+ +
4386                             ;       H   |       |       |
4386                             ;           +-+-+-+-+-+-+-+-+
4386                             ; 0-H to Seven Segment Table
4386   EB 28 CD AD 2E A7 E7 29 SEGTBL:   DB   0EBH,28H,0CDH,0ADH,2EH,0A7H,0E7H,29H   
438E   EF 2F 6F E6 C3 EC C7 47 DB   0EFH,2FH,6FH,0E6H,0C3H,0ECH,0C7H,47H   
4396   E3 6E                  DB   0E3H,6EH   
4398                             ; Intro Message
4398   39 00        INTMSG:   DB   39H,00H   ;Size + Gap
439A   40 40 7F 7F 40 40 00   DB   40H,40H,7FH,7FH,40H,40H,00H   ;T
43A1   7F 7F 49 49 00         DB   7FH,7FH,49H,49H,00H   ;E
43A6   1C 3E 63 41 41 00      DB   1CH,3EH,63H,41H,41H,00H   ;C
43AC   00 00                  DB   00H,00H   ;_
43AE   7F 7F 30 18 18 30 7F 7F 00 DB   7FH,7FH,30H,18H,18H,30H,7FH,7FH,00H   ;M
43B7   03 0E 3C 64 3C 0E 03 00 DB   03H,0EH,3CH,64H,3CH,0EH,03H,00H   ;A
43BF   63 67 6B 73 63 00      DB   63H,67H,6BH,73H,63H,00H   ;Z
43C5   7F 7F 49 49 00         DB   7FH,7FH,49H,49H,00H   ;E
43CA   00 00 00 00 00 00 00 00 DB   00H,00H,00H,00H,00H,00H,00H,00H   ;_
43D2                             ; Game Over Message
43D2   02           OVRMSG:   DB   02H   ;Page count
43D3   08 08 EB FC EA 09 04 00 DB   08H,08H,0EBH,0FCH,0EAH,09H,04H,00H   ;Boogie
43DB   04 09 EA FC EB 08 08 00 DB   04H,09H,0EAH,0FCH,0EBH,08H,08H,00H   ;Woogie


SCREEN:             5000 DEFINED AT LINE 41
                    > USED AT LINE 170
                    > USED AT LINE 231
                    > USED AT LINE 270
                    > USED AT LINE 276
                    > USED AT LINE 293
                    > USED AT LINE 419
                    > USED AT LINE 442
                    > USED AT LINE 511
                    > USED AT LINE 605
                    > USED AT LINE 613
                    > USED AT LINE 631
                    > USED AT LINE 650
                    > USED AT LINE 651
                    > USED AT LINE 665
ROTSCR:             5008 DEFINED AT LINE 42
                    > USED AT LINE 230
                    > USED AT LINE 257
                    > USED AT LINE 269
                    > USED AT LINE 281
TRESUR:             5010 DEFINED AT LINE 43
                    > USED AT LINE 190
                    > USED AT LINE 305
                    > USED AT LINE 379
                    > USED AT LINE 389
PLAYRM:             5018 DEFINED AT LINE 44
                    > USED AT LINE 191
                    > USED AT LINE 307
                    > USED AT LINE 462
                    > USED AT LINE 500
                    > USED AT LINE 559
PLAYSC:             5019 DEFINED AT LINE 45
                    > USED AT LINE 73
                    > USED AT LINE 220
                    > USED AT LINE 223
                    > USED AT LINE 404
PLAYER:             501A DEFINED AT LINE 46
                    > USED AT LINE 106
                    > USED AT LINE 162
                    > USED AT LINE 227
                    > USED AT LINE 367
                    > USED AT LINE 368
                    > USED AT LINE 418
                    > USED AT LINE 426
CURRRM:             501C DEFINED AT LINE 47
                    > USED AT LINE 78
                    > USED AT LINE 107
                    > USED AT LINE 240
                    > USED AT LINE 372
                    > USED AT LINE 478
STARTR:             501D DEFINED AT LINE 48
                    > USED AT LINE 76
                    > USED AT LINE 373
RANDNO:             501E DEFINED AT LINE 49
                    > USED AT LINE 542
                    > USED AT LINE 546
KEYPRE:             501F DEFINED AT LINE 50
                    > USED AT LINE 94
                    > USED AT LINE 98
                    > USED AT LINE 102
                    > USED AT LINE 408
LEDSCR:             5020 DEFINED AT LINE 51
                    > USED AT LINE 461
                    > USED AT LINE 512
TRELOC:             5026 DEFINED AT LINE 52
                    > USED AT LINE 184
                    > USED AT LINE 219
                    > USED AT LINE 306
                    > USED AT LINE 439
                    > USED AT LINE 449
START:              4000 DEFINED AT LINE 55
                    > USED AT LINE 82
GAME:               4009 DEFINED AT LINE 63
                    > USED AT LINE 75
                    > USED AT LINE 80
PLAYMV:             402A DEFINED AT LINE 87
                    > USED AT LINE 65
MP1:                4035 DEFINED AT LINE 96
                    > USED AT LINE 91
LEFT:               404A DEFINED AT LINE 109
RIGHT:              4055 DEFINED AT LINE 117
                    > USED AT LINE 111
UP:                 4060 DEFINED AT LINE 125
                    > USED AT LINE 119
DOWN:               406B DEFINED AT LINE 133
                    > USED AT LINE 127
MOVELT:             4075 DEFINED AT LINE 141
                    > USED AT LINE 114
MOVERT:             4079 DEFINED AT LINE 145
                    > USED AT LINE 122
MOVEUP:             407D DEFINED AT LINE 149
                    > USED AT LINE 130
MOVEDN:             4084 DEFINED AT LINE 155
                    > USED AT LINE 138
UPDROO:             4089 DEFINED AT LINE 160
                    > USED AT LINE 144
                    > USED AT LINE 148
                    > USED AT LINE 154
CHKCOL:             4091 DEFINED AT LINE 169
                    > USED AT LINE 116
                    > USED AT LINE 124
                    > USED AT LINE 132
                    > USED AT LINE 140
MP2:                4095 DEFINED AT LINE 173
                    > USED AT LINE 177
MP3:                409B DEFINED AT LINE 178
                    > USED AT LINE 175
MP4:                40B0 DEFINED AT LINE 194
                    > USED AT LINE 199
MP5:                40B7 DEFINED AT LINE 200
                    > USED AT LINE 196
MP6:                40C0 DEFINED AT LINE 208
                    > USED AT LINE 213
MP7:                40C8 DEFINED AT LINE 214
                    > USED AT LINE 210
MP8:                40DA DEFINED AT LINE 224
                    > USED AT LINE 181
NWROOM:             40EA DEFINED AT LINE 236
                    > USED AT LINE 163
                    > USED AT LINE 410
ROTCW:              4125 DEFINED AT LINE 274
                    > USED AT LINE 267
                    > USED AT LINE 296
ROT1:               412B DEFINED AT LINE 278
                    > USED AT LINE 291
ROT2:               4132 DEFINED AT LINE 283
                    > USED AT LINE 287
CRETRE:             4149 DEFINED AT LINE 302
                    > USED AT LINE 238
CR1:                415D DEFINED AT LINE 317
                    > USED AT LINE 322
CR2:                4164 DEFINED AT LINE 323
                    > USED AT LINE 319
CR3:                4167 DEFINED AT LINE 327
                    > USED AT LINE 332
CR4:                416F DEFINED AT LINE 333
                    > USED AT LINE 329
CR5:                417C DEFINED AT LINE 346
                    > USED AT LINE 340
CR6:                4183 DEFINED AT LINE 351
                    > USED AT LINE 353
CR7:                4189 DEFINED AT LINE 357
                    > USED AT LINE 335
SETUP:              418D DEFINED AT LINE 364
                    > USED AT LINE 61
SUP1:               41A5 DEFINED AT LINE 380
                    > USED AT LINE 385
SUP2:               41B3 DEFINED AT LINE 390
                    > USED AT LINE 401
SUP3:               41B6 DEFINED AT LINE 393
                    > USED AT LINE 398
SUP4:               41BA DEFINED AT LINE 397
                    > USED AT LINE 395
UPDSCR:             41D0 DEFINED AT LINE 415
                    > USED AT LINE 67
U1:                 41D6 DEFINED AT LINE 420
                    > USED AT LINE 424
U2:                 41DC DEFINED AT LINE 425
                    > USED AT LINE 422
U3:                 41F1 DEFINED AT LINE 443
                    > USED AT LINE 447
U4:                 41F7 DEFINED AT LINE 448
                    > USED AT LINE 445
UPDSCO:             41FF DEFINED AT LINE 460
                    > USED AT LINE 68
UPDRCO:             4214 DEFINED AT LINE 477
                    > USED AT LINE 237
SU1:                421D DEFINED AT LINE 483
                    > USED AT LINE 490
SU2:                4224 DEFINED AT LINE 489
                    > USED AT LINE 487
SCAN:               4233 DEFINED AT LINE 506
                    > USED AT LINE 69
S1:                 4235 DEFINED AT LINE 508
                    > USED AT LINE 535
S2:                 423E DEFINED AT LINE 513
                    > USED AT LINE 533
S3:                 424D DEFINED AT LINE 523
                    > USED AT LINE 521
S4:                 424F DEFINED AT LINE 525
                    > USED AT LINE 525
RANDOM:             4261 DEFINED AT LINE 539
                    > USED AT LINE 370
                    > USED AT LINE 381
                    > USED AT LINE 435
SEGCON:             426E DEFINED AT LINE 550
                    > USED AT LINE 469
                    > USED AT LINE 472
SC1:                4281 DEFINED AT LINE 566
                    > USED AT LINE 563
SC2:                4284 DEFINED AT LINE 568
                    > USED AT LINE 565
SC3:                428B DEFINED AT LINE 572
                    > USED AT LINE 569
HEX2BCD:            4293 DEFINED AT LINE 583
                    > USED AT LINE 403
H1:                 4298 DEFINED AT LINE 588
                    > USED AT LINE 592
INTROM:             42A0 DEFINED AT LINE 599
                    > USED AT LINE 58
SL1:                42A5 DEFINED AT LINE 603
                    > USED AT LINE 616
SL2:                42AB DEFINED AT LINE 606
                    > USED AT LINE 610
GAMEOV:             42C1 DEFINED AT LINE 624
                    > USED AT LINE 81
                    > USED AT LINE 646
F1:                 42C7 DEFINED AT LINE 629
                    > USED AT LINE 645
F2:                 42D2 DEFINED AT LINE 635
                    > USED AT LINE 639
CLRSCR:             42E5 DEFINED AT LINE 649
                    > USED AT LINE 57
SCAN88:             42F3 DEFINED AT LINE 659
                    > USED AT LINE 614
                    > USED AT LINE 637
S81:                42F6 DEFINED AT LINE 662
                    > USED AT LINE 680
S82:                42FC DEFINED AT LINE 666
                    > USED AT LINE 678
S83:                4304 DEFINED AT LINE 672
                    > USED AT LINE 672
CROSSR:             4314 DEFINED AT LINE 700
                    > USED AT LINE 707
TJUNCR:             431C DEFINED AT LINE 701
                    > USED AT LINE 707
STRGTR:             4324 DEFINED AT LINE 702
BENDRM:             432C DEFINED AT LINE 703
CULDSR:             4334 DEFINED AT LINE 704
ROOMLU:             433C DEFINED AT LINE 707
                    > USED AT LINE 248
MAZERM:             4346 DEFINED AT LINE 709
                    > USED AT LINE 239
SEGTBL:             4386 DEFINED AT LINE 739
                    > USED AT LINE 564
                    > USED AT LINE 567
                    > USED AT LINE 571
INTMSG:             4398 DEFINED AT LINE 744
                    > USED AT LINE 600
OVRMSG:             43D2 DEFINED AT LINE 756
                    > USED AT LINE 625
