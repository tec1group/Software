0000                             ; Magic Square
0000                             ; 
0000                             ; Keys Used are 4,5,6,8,9,A,C,D,E.  Uses the 8x8 LED Matrix connected to ports 5 & 6
0000                             ; Need to end up with a hollow square
0000                             ; 
0000                SCREEN:   EQU   5000H   ;Screen data for 8x8                 (8-bytes)
0000                SQRDAT:   EQU   5009H   ;Store top, middle and bottom rows   (3-bytes)
0000                KEYFLG:   EQU   500CH   ;Key Pressed Flag                    (1-byte)
4000                          .ORG   4000H   
4000                START:       
4000   11 00 00               LD   DE,0000H   ;Random Number generator
4003                LOOP1:       
4003   13                     INC   DE   
4004   DB 03                  IN   A,(03)   
4006   CB 77                  BIT   6,A   
4008   28 F9                  JR   Z,LOOP1   
400A   ED 5F                  LD   A,R   
400C   82                     ADD   A,D   
400D   32 09 50               LD   (SQRDAT),A   
4010   8B                     ADC   A,E   
4011   32 0A 50               LD   (SQRDAT+1),A   
4014   82                     ADD   A,D   
4015   83                     ADD   A,E   
4016   07                     RLCA      
4017   32 0B 50               LD   (SQRDAT+2),A   
401A                PRINT:       
401A   CD AD 40               CALL   FORMAT   
401D                GAME:        
401D   CD EA 40               CALL   SCAN   
4020   DB 03                  IN   A,(03)   
4022   CB 77                  BIT   6,A   
4024   28 06                  JR   Z,KEYHIT   
4026   AF                     XOR   A   
4027   32 0C 50               LD   (KEYFLG),A   
402A   18 F1                  JR   GAME   
402C                KEYHIT:      
402C   3A 0C 50               LD   A,(KEYFLG)   
402F   B7                     OR   A   
4030   20 EB                  JR   NZ,GAME   
4032   3E FF                  LD   A,0FFH   
4034   32 0C 50               LD   (KEYFLG),A   
4037   21 03 41               LD   HL,DATTBL   
403A   01 09 00               LD   BC,0009H   
403D   DB 00                  IN   A,(00)   
403F   E6 1F                  AND   1FH   
4041   ED B1                  CPIR      
4043   20 D8                  JR   NZ,GAME   
4045   CD DA 40               CALL   BEEP   
4048   2B                     DEC   HL   
4049   11 09 00               LD   DE,0009H   
404C   06 03                  LD   B,03H   
404E                LOOP2:       
404E   19                     ADD   HL,DE   
404F   7E                     LD   A,(HL)   
4050   19                     ADD   HL,DE   
4051   E5                     PUSH   HL   
4052   6E                     LD   L,(HL)   
4053   26 50                  LD   H,50H   ;Force to use RAM
4055   AE                     XOR   (HL)   
4056   77                     LD   (HL),A   
4057   E1                     POP   HL   
4058   10 F4                  DJNZ   LOOP2   
405A   21 09 50               LD   HL,SQRDAT   
405D   7E                     LD   A,(HL)   
405E   E6 07                  AND   07H   
4060   FE 07                  CP   07H   
4062   20 B6                  JR   NZ,PRINT   
4064   23                     INC   HL   
4065   7E                     LD   A,(HL)   
4066   E6 07                  AND   07H   
4068   FE 05                  CP   05H   
406A   20 AE                  JR   NZ,PRINT   
406C   23                     INC   HL   
406D   7E                     LD   A,(HL)   
406E   E6 07                  AND   07H   
4070   FE 07                  CP   07H   
4072   20 A6                  JR   NZ,PRINT   
4074   CD AD 40               CALL   FORMAT   
4077   11 30 00               LD   DE,0030H   
407A   CD DD 40               CALL   BEEP+3   
407D   06 03                  LD   B,03H   
407F                LOOP3:       
407F   C5                     PUSH   BC   
4080   16 10                  LD   D,10H   
4082                LOOP4:       
4082   CD EA 40               CALL   SCAN   
4085   15                     DEC   D   
4086   20 FA                  JR   NZ,LOOP4   
4088   AF                     XOR   A   
4089   D3 06                  OUT   (06),A   
408B   CD DA 40               CALL   BEEP   
408E   01 00 15               LD   BC,1500H   
4091                LOOP5:       
4091   0B                     DEC   BC   
4092   78                     LD   A,B   
4093   B1                     OR   C   
4094   20 FB                  JR   NZ,LOOP5   
4096   C1                     POP   BC   
4097   10 E6                  DJNZ   LOOP3   
4099                LOOP6:       
4099   CD EA 40               CALL   SCAN   
409C   DB 00                  IN   A,(00)   
409E   E6 1F                  AND   1FH   
40A0   FE 12                  CP   12H   
40A2   20 F5                  JR   NZ,LOOP6   
40A4   11 80 00               LD   DE,0080H   
40A7   CD DD 40               CALL   BEEP+3   
40AA   C3 00 40               JP   START   
40AD                FORMAT:      
40AD   06 03                  LD   B,03H   
40AF   21 09 50               LD   HL,SQRDAT   
40B2   11 00 50               LD   DE,SCREEN   
40B5                LOOP7:       
40B5   C5                     PUSH   BC   
40B6   7E                     LD   A,(HL)   
40B7   CD C6 40               CALL   BITCON   
40BA   12                     LD   (DE),A   
40BB   13                     INC   DE   
40BC   12                     LD   (DE),A   
40BD   13                     INC   DE   
40BE   AF                     XOR   A   
40BF   12                     LD   (DE),A   
40C0   13                     INC   DE   
40C1   23                     INC   HL   
40C2   C1                     POP   BC   
40C3   10 F0                  DJNZ   LOOP7   
40C5   C9                     RET      
40C6                BITCON:      
40C6   01 00 03               LD   BC,0300H   
40C9                LOOP8:       
40C9   0F                     RRCA      
40CA   30 02                  JR   NC,ROTC   
40CC   CB F9                  SET   7,C   
40CE                ROTC:        
40CE   CB 11                  RL   C   
40D0   CB 11                  RL   C   
40D2   CB 11                  RL   C   
40D4   10 F3                  DJNZ   LOOP8   
40D6   CB 19                  RR   C   
40D8   79                     LD   A,C   
40D9   C9                     RET      
40DA                BEEP:        
40DA   11 50 50               LD   DE,5050H   
40DD   3E 80                  LD   A,80H   
40DF                LOOP9:       
40DF   D3 01                  OUT   (01),A   
40E1   42                     LD   B,D   
40E2   10 FE        LOOP10:   DJNZ   LOOP10   
40E4   EE 80                  XOR   80H   
40E6   1D                     DEC   E   
40E7   20 F6                  JR   NZ,LOOP9   
40E9                             ;            XOR     A
40E9                             ;            OUT     (01),A
40E9   C9                     RET      
40EA                SCAN:        
40EA   21 07 50               LD   HL,SCREEN+7   
40ED   06 80                  LD   B,80H   
40EF                LOOP11:      
40EF   7E                     LD   A,(HL)   
40F0   D3 05                  OUT   (05),A   
40F2   78                     LD   A,B   
40F3   D3 06                  OUT   (06),A   
40F5   06 40                  LD   B,40H   
40F7   10 FE        LOOP12:   DJNZ   LOOP12   
40F9   2B                     DEC   HL   
40FA   47                     LD   B,A   
40FB   AF                     XOR   A   
40FC   D3 06                  OUT   (06),A   
40FE   CB 08                  RRC   B   
4100   30 ED                  JR   NC,LOOP11   
4102   C9                     RET      
4103   04 08 0C 05 09 0D 06 0A 0E DATTBL:   DB   04H,08H,0CH,05H,09H,0DH,06H,0AH,0EH   ;key pressed
410C   06 04 00 07 02 00 03 01 00 DB   06H,04H,00H,07H,02H,00H,03H,01H,00H   ;bottom row bits of key pressed
4115   09 09 09 09 09 09 09 09 09 DB   09H,09H,09H,09H,09H,09H,09H,09H,09H   ;first 3x3 location SQRDAT
411E   04 06 04 02 07 02 01 03 01 DB   04H,06H,04H,02H,07H,02H,01H,03H,01H   ;middle row bits of key pressed
4127   0A 0A 0A 0A 0A 0A 0A 0A 0A DB   0AH,0AH,0AH,0AH,0AH,0AH,0AH,0AH,0AH   ;second 3x3 location SQRDAT+1
4130   00 04 06 00 02 07 00 01 03 DB   00H,04H,06H,00H,02H,07H,00H,01H,03H   ;top row bits of key pressed
4139   0B 0B 0B 0B 0B 0B 0B 0B 0B DB   0BH,0BH,0BH,0BH,0BH,0BH,0BH,0BH,0BH   ;third 3x3 location SQRDAT+2


SCREEN:             5000 DEFINED AT LINE 6
                    > USED AT LINE 114
                    > USED AT LINE 158
SQRDAT:             5009 DEFINED AT LINE 7
                    > USED AT LINE 21
                    > USED AT LINE 23
                    > USED AT LINE 27
                    > USED AT LINE 65
                    > USED AT LINE 113
KEYFLG:             500C DEFINED AT LINE 8
                    > USED AT LINE 36
                    > USED AT LINE 39
                    > USED AT LINE 43
START:              4000 DEFINED AT LINE 12
                    > USED AT LINE 110
LOOP1:              4003 DEFINED AT LINE 14
                    > USED AT LINE 18
PRINT:              401A DEFINED AT LINE 28
                    > USED AT LINE 69
                    > USED AT LINE 74
                    > USED AT LINE 79
GAME:               401D DEFINED AT LINE 30
                    > USED AT LINE 37
                    > USED AT LINE 41
                    > USED AT LINE 49
KEYHIT:             402C DEFINED AT LINE 38
                    > USED AT LINE 34
LOOP2:              404E DEFINED AT LINE 54
                    > USED AT LINE 64
LOOP3:              407F DEFINED AT LINE 84
                    > USED AT LINE 101
LOOP4:              4082 DEFINED AT LINE 87
                    > USED AT LINE 90
LOOP5:              4091 DEFINED AT LINE 95
                    > USED AT LINE 99
LOOP6:              4099 DEFINED AT LINE 102
                    > USED AT LINE 107
FORMAT:             40AD DEFINED AT LINE 111
                    > USED AT LINE 29
                    > USED AT LINE 80
LOOP7:              40B5 DEFINED AT LINE 115
                    > USED AT LINE 128
BITCON:             40C6 DEFINED AT LINE 130
                    > USED AT LINE 118
LOOP8:              40C9 DEFINED AT LINE 132
                    > USED AT LINE 140
ROTC:               40CE DEFINED AT LINE 136
                    > USED AT LINE 134
BEEP:               40DA DEFINED AT LINE 144
                    > USED AT LINE 50
                    > USED AT LINE 82
                    > USED AT LINE 93
                    > USED AT LINE 109
LOOP9:              40DF DEFINED AT LINE 147
                    > USED AT LINE 153
LOOP10:             40E2 DEFINED AT LINE 150
                    > USED AT LINE 150
SCAN:               40EA DEFINED AT LINE 157
                    > USED AT LINE 31
                    > USED AT LINE 88
                    > USED AT LINE 103
LOOP11:             40EF DEFINED AT LINE 160
                    > USED AT LINE 172
LOOP12:             40F7 DEFINED AT LINE 166
                    > USED AT LINE 166
DATTBL:             4103 DEFINED AT LINE 175
                    > USED AT LINE 44
